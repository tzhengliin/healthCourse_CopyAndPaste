<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>快速複製文字與圖片工具（多檔下載）</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=double_arrow" />
    <style>
      html {
        scroll-behavior: smooth;
      }
      body {
        background: #f8f9fa;
      }
      .app-header {
        letter-spacing: 0.05em;
      }
      .card {
        border: 0;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      }
      .input-group textarea.form-control {
        resize: none;
        min-height: 48px;
      }
      .copy-btn {
        min-width: 110px;
      }
      .footer-note {
        color: #6c757d;
      }

      /* === 縮圖與右側按鈕 === */
      .img-line {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
      }
      .drop-zone {
        border: 2px dashed #adb5bd;
        border-radius: 0.75rem;
        padding: 8px;
        text-align: center;
        background: #fff;
        display: inline-flex;
      }
      .drop-zone.dragover {
        border-color: #0d6efd;
        background: #eef5ff;
      }

      /* 固定 200x200 的縮圖盒子（置中顯示圖片） */
      .img-wrap {
        width: 200px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .img-wrap img {
        max-width: 200px;
        max-height: 200px;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 0.5rem;
      }

      .img-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .img-actions .btn {
        min-width: 140px;
      }

      .time-section + .time-section {
        margin-top: 0.5rem;
      }

      /* 書籤列樣式 */
      .bookmark-bar {
        gap: 0.5rem;
      }
      .bookmark-bar .btn {
        --bs-btn-padding-y: 0.25rem;
        --bs-btn-padding-x: 0.6rem;
        --bs-btn-font-size: 0.9rem;
      }

      /* 精準錨點對齊（如果上方空間更高可加大數值） */
      .time-section {
        scroll-margin-top: 72px;
      }
    </style>
  </head>
  <body>
    <main class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-9 col-xl-8">
          <header class="mb-4 text-center">
            <h1 class="h3 app-header fw-semibold">快速複製文字與圖片工具</h1>
            <p class="text-secondary mb-0">資料驅動渲染；每個時段可有多筆文字與多張圖片。下方提供時段書籤快速定位。</p>
          </header>

          <!-- 分類切換（動態產生） -->
          <ul class="nav nav-pills mb-2 justify-content-center" id="categoryTabs" role="tablist"></ul>

          <!-- 各時段書籤列（依當前分類動態更新） -->
          <div id="timeBookmarkBar" class="bookmark-bar d-flex flex-wrap justify-content-center mb-3"></div>

          <!-- 內容區（動態產生） -->
          <div class="tab-content" id="tabContentRoot"></div>

          <div class="text-center mt-3">
            <small class="footer-note">高雄博士班 製作</small>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
      <div id="copyToast" class="toast text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body" id="toastMsg">已複製</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /** =========================
       *  資料庫／陣列
       *  結構：DATA = { "分類": { "HH:MM": { texts:[...], images:[...] }, ... }, ... }
       *  ========================= */
      const IMG_BASE = "https://raw.githubusercontent.com/tzhengliin/healthCourse_CopyAndPaste/refs/heads/main/pic/";
      const NEW_IMG_BASE = "https://raw.githubusercontent.com/tzhengliin/healthCourse_CopyAndPaste/refs/heads/main/pic/notice(new)/";
      const TIME_ORDER = ["07:45", "08:00", "10:00", "11:45", "12:00", "14:00", "16:00", "17:45", "18:00", "20:00"];

      const DATA = {
        準備日: {
          "07:45": { texts: ["07:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "000.jpg", NEW_IMG_BASE + "1.png"] },
          "08:00": { texts: ["08:00\t早餐~早餐~準備吃早餐囉"], images: [IMG_BASE + "002.jpg", NEW_IMG_BASE + "2.png", NEW_IMG_BASE + "3.png"] },
          "10:00": { texts: ["10:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "005.jpg", NEW_IMG_BASE + "4.png", NEW_IMG_BASE + "5.png"] },
          "11:45": { texts: ["11:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "001.jpg", NEW_IMG_BASE + "6.png"] },
          "12:00": { texts: ["12:00\t午餐是一整天的中場休息，記得慢慢嚼慢慢吃哦"], images: [IMG_BASE + "003.jpg", NEW_IMG_BASE + "7.png", NEW_IMG_BASE + "8.png"] },
          "14:00": { texts: ["14:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "005.jpg", NEW_IMG_BASE + "9.png", NEW_IMG_BASE + "10.png"] },
          "16:00": { texts: ["16:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "005.jpg", NEW_IMG_BASE + "11.png", NEW_IMG_BASE + "12.png"] },
          "17:45": { texts: ["17:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "001.jpg", NEW_IMG_BASE + "13.png"] },
          "18:00": { texts: ["18:00\t準備吃晚餐囉~美好的夜晚配上健康的食物"], images: [IMG_BASE + "004.jpg", NEW_IMG_BASE + "14.png", NEW_IMG_BASE + "15.png"] },
          "20:00": { texts: ["20:00\t最後的燃脂時刻到，今天又是美好的一天"], images: [IMG_BASE + "005.jpg", NEW_IMG_BASE + "16.png", NEW_IMG_BASE + "17.png"] },
        },
        蛋白日: {
          "07:45": { texts: ["07:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "100.jpg", NEW_IMG_BASE + "1.png"] },
          "08:00": { texts: ["08:00\t早餐~早餐~準備吃早餐囉"], images: [IMG_BASE + "102.jpg", NEW_IMG_BASE + "2.png", NEW_IMG_BASE + "3.png", NEW_IMG_BASE + "20.png"] },
          "10:00": { texts: ["10:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "105.jpg", NEW_IMG_BASE + "4.png", NEW_IMG_BASE + "5.png"] },
          "11:45": { texts: ["11:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "101.jpg", NEW_IMG_BASE + "6.png"] },
          "12:00": { texts: ["12:00\t午餐是一整天的中場休息，記得慢慢嚼慢慢吃哦"], images: [IMG_BASE + "103.jpg", NEW_IMG_BASE + "7.png", NEW_IMG_BASE + "8.png", NEW_IMG_BASE + "21.png"] },
          "14:00": { texts: ["14:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "105.jpg", NEW_IMG_BASE + "9.png", NEW_IMG_BASE + "10.png"] },
          "16:00": { texts: ["16:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "105.jpg", NEW_IMG_BASE + "11.png", NEW_IMG_BASE + "12.png"] },
          "17:45": { texts: ["17:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "101.jpg", NEW_IMG_BASE + "13.png"] },
          "18:00": { texts: ["18:00\t準備吃晚餐囉~美好的夜晚配上健康的食物"], images: [IMG_BASE + "104.jpg", NEW_IMG_BASE + "14.png", NEW_IMG_BASE + "15.png", NEW_IMG_BASE + "21.png"] },
          "20:00": { texts: ["20:00\t最後的燃脂時刻到，今天又是美好的一天"], images: [IMG_BASE + "105.jpg", NEW_IMG_BASE + "16.png", NEW_IMG_BASE + "17.png"] },
        },
        纖體日: {
          "07:45": { texts: ["07:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "200.jpg", NEW_IMG_BASE + "1.png"] },
          "08:00": { texts: ["08:00\t早餐~早餐~準備吃早餐囉"], images: [IMG_BASE + "202.jpg", NEW_IMG_BASE + "2.png", NEW_IMG_BASE + "3.png", NEW_IMG_BASE + "18.png"] },
          "10:00": { texts: ["10:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "205.jpg", NEW_IMG_BASE + "4.png", NEW_IMG_BASE + "5.png"] },
          "11:45": { texts: ["11:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "201.jpg", NEW_IMG_BASE + "6.png"] },
          "12:00": { texts: ["12:00\t午餐是一整天的中場休息，記得慢慢嚼慢慢吃哦"], images: [IMG_BASE + "203.jpg", NEW_IMG_BASE + "7.png", NEW_IMG_BASE + "8.png", NEW_IMG_BASE + "19.png"] },
          "14:00": { texts: ["14:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "205.jpg", NEW_IMG_BASE + "9.png", NEW_IMG_BASE + "10.png"] },
          "16:00": { texts: ["16:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "205.jpg", NEW_IMG_BASE + "11.png", NEW_IMG_BASE + "12.png"] },
          "17:45": { texts: ["17:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "201.jpg", NEW_IMG_BASE + "13.png"] },
          "18:00": { texts: ["18:00\t準備吃晚餐囉~美好的夜晚配上健康的食物"], images: [IMG_BASE + "204.jpg", NEW_IMG_BASE + "14.png", NEW_IMG_BASE + "15.png", NEW_IMG_BASE + "19.png"] },
          "20:00": { texts: ["20:00\t最後的燃脂時刻到，今天又是美好的一天"], images: [IMG_BASE + "205.jpg", NEW_IMG_BASE + "16.png", NEW_IMG_BASE + "17.png"] },
        },
        新陳代謝日: {
          "07:45": { texts: ["07:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "300.jpg", NEW_IMG_BASE + "1.png"] },
          "08:00": { texts: ["08:00\t早餐~早餐~準備吃早餐囉"], images: [IMG_BASE + "302.jpg", NEW_IMG_BASE + "2.png", NEW_IMG_BASE + "3.png", NEW_IMG_BASE + "23.png"] },
          "10:00": { texts: ["10:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "305.jpg", NEW_IMG_BASE + "4.png", NEW_IMG_BASE + "5.png"] },
          "11:45": { texts: ["11:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "301.jpg", NEW_IMG_BASE + "6.png"] },
          "12:00": { texts: ["12:00\t午餐是一整天的中場休息，記得慢慢嚼慢慢吃哦"], images: [IMG_BASE + "303.jpg", NEW_IMG_BASE + "7.png", NEW_IMG_BASE + "8.png", NEW_IMG_BASE + "24.png"] },
          "14:00": { texts: ["14:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "305.jpg", NEW_IMG_BASE + "9.png", NEW_IMG_BASE + "10.png"] },
          "16:00": { texts: ["16:00\t燃脂時刻到，記得吃小餐哦"], images: [IMG_BASE + "305.jpg", NEW_IMG_BASE + "11.png", NEW_IMG_BASE + "12.png"] },
          "17:45": { texts: ["17:45\t餐前時刻，記得與正餐間隔15~30分鐘哦"], images: [IMG_BASE + "301.jpg", NEW_IMG_BASE + "13.png"] },
          "18:00": { texts: ["18:00\t準備吃晚餐囉~美好的夜晚配上健康的食物"], images: [IMG_BASE + "304.jpg", NEW_IMG_BASE + "14.png", NEW_IMG_BASE + "15.png", NEW_IMG_BASE + "24.png"] },
          "20:00": { texts: ["20:00\t最後的燃脂時刻到，今天又是美好的一天"], images: [IMG_BASE + "305.jpg", NEW_IMG_BASE + "16.png", NEW_IMG_BASE + "17.png"] },
        },
      };

      /** ============== 工具函式（UI 與互動） ============== */
      function autoResize(el) {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + 2 + "px";
      }

      const toastEl = document.getElementById("copyToast");
      const toastMsg = document.getElementById("toastMsg");
      const bsToast = new bootstrap.Toast(toastEl, { delay: 1400 });
      function showToast(msg) {
        toastMsg.textContent = msg;
        bsToast.show();
      }

      async function copyFromSelector(selector, btn) {
        const el = document.querySelector(selector);
        if (!el) return;
        const text = el.value ?? "";
        try {
          await navigator.clipboard.writeText(text);
          buttonBlink(btn, "已複製");
          showToast("已複製：" + (text.length > 22 ? text.slice(0, 22) + "…" : text));
        } catch {
          showToast("複製失敗");
        }
      }

      function buttonBlink(btn, label) {
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-clipboard-check"></i> ' + (label || "已複製");
        btn.disabled = true;
        setTimeout(() => {
          btn.innerHTML = orig;
          btn.disabled = false;
        }, 1200);
      }

      async function copyImageFrom(selector, btn) {
        const img = document.querySelector(selector);
        if (!img) return;
        try {
          const blob = await imageToBlob(img);
          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
          buttonBlink(btn, "已複製圖片");
          showToast("圖片已複製到剪貼簿");
        } catch (err) {
          console.error(err);
          showToast("無法複製圖片：瀏覽器或權限限制");
        }
      }

      function imageToBlob(img) {
        return new Promise((resolve, reject) => {
          const canvas = document.createElement("canvas");
          canvas.width = img.naturalWidth || img.width;
          canvas.height = img.naturalHeight || img.height;
          const ctx = canvas.getContext("2d");
          try {
            ctx.drawImage(img, 0, 0);
            canvas.toBlob((b) => (b ? resolve(b) : reject(new Error("toBlob 失敗"))), "image/png");
          } catch (e) {
            reject(e);
          }
        });
      }

      async function downloadImage(selector) {
        const img = document.querySelector(selector);
        if (!img) return;
        try {
          const blob = await imageToBlob(img);
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "image.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showToast("已下載圖片");
        } catch {
          showToast("下載失敗");
        }
      }

      // 嘗試 fetch 取得 blob；若失敗（CORS 或 blob:）退回 canvas 轉
      async function getImgBlobSmart(img) {
        try {
          const res = await fetch(img.src, { mode: "cors" });
          if (!res.ok) throw new Error("fetch failed");
          return await res.blob();
        } catch {
          return await imageToBlob(img);
        }
      }

      // 多檔下載：依序觸發各圖檔下載，避免被瀏覽器阻擋
      async function downloadAllIndividually(sectionId, btn) {
        const section = document.getElementById(sectionId);
        if (!section) return;
        const imgs = Array.from(section.querySelectorAll("img"));
        if (imgs.length === 0) {
          showToast("這個時段沒有圖片可下載");
          return;
        }

        // 檔名前綴
        const pane = section.closest(".tab-pane");
        const catIdx = pane?.dataset?.catIdx ?? "0";
        const catName = document.querySelector(`button[data-cat-idx="${catIdx}"]`)?.textContent?.trim() || "分類";
        const timeStr =
          section
            .querySelector("label")
            ?.textContent?.trim()
            .match(/\d{2}:\d{2}/)?.[0] || "時段";

        if (btn) {
          btn.disabled = true;
          const orig = btn.innerHTML;
          btn.dataset._orig = orig;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>準備下載…';
        }

        try {
          let i = 1;
          for (const img of imgs) {
            // 取得 Blob
            const blob = await getImgBlobSmart(img);
            // 產生檔名
            const nameFromUrl = (img.currentSrc || img.src || "").split("/").pop()?.split("?")[0] || "";
            const extGuess = (blob.type && blob.type.split("/")[1]) || nameFromUrl.split(".").pop() || "png";
            const safeExt = extGuess.replace(/[^a-zA-Z0-9]/g, "") || "png";
            const filename = `${catName}-${timeStr.replace(":", "")}-${i}.${safeExt}`;

            // 建立臨時連結並觸發下載
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            // 短暫延遲，降低被瀏覽器阻擋的機率
            await new Promise((r) => setTimeout(r, 180));
            i++;
          }
          showToast(`已開始下載：${catName} ${timeStr} 的 ${imgs.length} 張圖片`);
        } catch (e) {
          console.error(e);
          showToast("多檔下載發生錯誤");
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = btn.dataset._orig || "下載全部";
          }
        }
      }

      function wireImageInputs() {
        document.querySelectorAll(".copy-img-btn").forEach((btn) => {
          btn.addEventListener("click", () => copyImageFrom(btn.dataset.target, btn));
        });
        document.querySelectorAll(".download-img-btn").forEach((btn) => {
          btn.addEventListener("click", () => downloadImage(btn.dataset.target));
        });
        document.querySelectorAll('input[type="file"][data-target-img]').forEach((input) => {
          input.addEventListener("change", () => {
            const file = input.files && input.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            const img = document.querySelector(input.dataset.targetImg);
            if (img) {
              img.src = url;
              img.onload = () => URL.revokeObjectURL(url);
            }
          });
        });
        document.querySelectorAll(".drop-zone").forEach((zone) => {
          const targetSel = zone.getAttribute("data-target-img");
          zone.addEventListener("dragover", (e) => {
            e.preventDefault();
            zone.classList.add("dragover");
          });
          zone.addEventListener("dragleave", () => zone.classList.remove("dragover"));
          zone.addEventListener("drop", async (e) => {
            e.preventDefault();
            zone.classList.remove("dragover");
            const file = e.dataTransfer.files && e.dataTransfer.files[0];
            if (!file) return;
            if (!file.type.startsWith("image/")) {
              showToast("請拖放圖片檔案");
              return;
            }
            const img = document.querySelector(targetSel);
            const url = URL.createObjectURL(file);
            if (img) {
              img.src = url;
              img.onload = () => URL.revokeObjectURL(url);
            }
          });
        });

        // 綁定「下載全部」按鈕（多檔下載）
        document.querySelectorAll(".download-all-btn").forEach((btn) => {
          btn.addEventListener("click", () => downloadAllIndividually(btn.dataset.sectionId, btn));
        });
      }

      function createDownloadButtons() {
        document.querySelectorAll(".copy-img-btn").forEach((copyBtn) => {
          const sel = copyBtn.dataset.target;
          const dlBtn = document.createElement("button");
          dlBtn.type = "button";
          dlBtn.className = "btn btn-outline-secondary download-img-btn";
          dlBtn.setAttribute("data-target", sel);
          dlBtn.innerHTML = '<i class="bi bi-download"></i> 下載圖片';
          copyBtn.parentElement.appendChild(dlBtn);
        });
      }

      /** ============== 動態渲染：分類、時段、內容 ============== */
      function renderApp(data) {
        const tabs = document.getElementById("categoryTabs");
        const root = document.getElementById("tabContentRoot");
        tabs.innerHTML = "";
        root.innerHTML = "";

        const categories = Object.keys(data);
        categories.forEach((catName, idx) => {
          const tabId = `tab-${idx}`;
          const paneId = `pane-${idx}`;

          // Tab 按鈕
          const li = document.createElement("li");
          li.className = "nav-item";
          li.role = "presentation";
          li.innerHTML = `
            <button class="nav-link ${idx === 0 ? "active" : ""}" id="${tabId}"
              data-bs-toggle="pill" data-bs-target="#${paneId}" type="button" role="tab"
              data-cat-idx="${idx}">
              ${catName}
            </button>`;
          tabs.appendChild(li);

          // 內容 Pane
          const pane = document.createElement("div");
          pane.className = `tab-pane fade ${idx === 0 ? "show active" : ""}`;
          pane.id = paneId;
          pane.role = "tabpanel";
          pane.setAttribute("data-cat-idx", idx);
          pane.innerHTML = `
            <div class="card mb-3">
              <div class="card-body">
                <div class="vstack gap-3" id="${paneId}-stack"></div>
              </div>
            </div>`;
          root.appendChild(pane);

          // 時段區域
          const stack = pane.querySelector(`#${paneId}-stack`);
          const timeMap = data[catName];

          TIME_ORDER.filter((t) => t in timeMap).forEach((timeStr) => {
            const sectionId = `${paneId}-${timeStr.replace(":", "")}`;
            const sec = document.createElement("section");
            sec.className = "time-section";
            sec.id = sectionId;

            // 標題列：左側時間標籤 + 右側「下載全部」
            const headerHtml = `
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label mb-2 fs-3 fw-semibold mb-0">
                  <span class="material-symbols-outlined">double_arrow</span>${timeStr}
                </label>
                <button class="btn btn-outline-secondary btn-sm download-all-btn" type="button"
                        data-section-id="${sectionId}">
                  <i class="bi bi-download"></i> 下載全部
                </button>
              </div>`;

            sec.innerHTML = `
              <hr class="my-4" />
              ${headerHtml}
              <div class="vstack gap-3" id="${sectionId}-content"></div>
            `;
            stack.appendChild(sec);

            const holder = sec.querySelector(`#${sectionId}-content`);
            const { texts = [], images = [] } = timeMap[timeStr] || {};

            // 多筆文字
            texts.forEach((text, ti) => {
              const textId = `${sectionId}-text-${ti}`;
              const textBlock = document.createElement("div");
              textBlock.className = "input-group";
              textBlock.innerHTML = `
                <textarea id="${textId}" class="form-control auto-resize">${escapeHTML(text)}</textarea>
                <button class="btn btn-primary copy-btn" type="button" data-target="#${textId}">
                  <i class="bi bi-clipboard"></i> 複製
                </button>
              `;
              holder.appendChild(textBlock);
            });

            // 多張圖片（縮圖 + 右側按鈕）
            images.forEach((imgUrl, ii) => {
              const imgId = `${sectionId}-img-${ii}`;
              const block = document.createElement("div");
              block.className = "img-line";
              block.innerHTML = `
                <div class="drop-zone" data-target-img="#${imgId}">
                  <div class="img-wrap">
                    <img id="${imgId}" src="${imgUrl}" alt="${catName}${timeStr}-圖片${ii + 1}" crossorigin="anonymous" />
                  </div>
                </div>
                <div class="img-actions">
                  <button class="btn btn-outline-primary copy-img-btn" type="button" data-target="#${imgId}">
                    <i class="bi bi-clipboard2"></i> 複製圖片
                  </button>
                  <!-- 下載按鈕稍後用 JS 補上到這個容器內 -->
                </div>
              `;
              holder.appendChild(block);
            });
          });
        });
      }

      // 書籤列（依目前選取的分類）
      function renderTimeBookmarksForCategory(catIdx) {
        const bar = document.getElementById("timeBookmarkBar");
        bar.innerHTML = "";
        const pane = document.getElementById(`pane-${catIdx}`);
        if (!pane) return;
        const sections = Array.from(pane.querySelectorAll(".time-section"));
        if (!sections.length) return;

        sections.forEach((sec) => {
          const timeStr =
            sec
              .querySelector("label")
              ?.textContent?.trim()
              .match(/\d{2}:\d{2}/)?.[0] || "";
          const a = document.createElement("a");
          a.className = "btn btn-outline-secondary";
          a.href = `#${sec.id}`;
          a.textContent = timeStr;

          a.addEventListener("click", (e) => {
            e.preventDefault();
            const tabBtn = document.querySelector(`button[data-cat-idx="${catIdx}"]`);
            const targetSection = sec.closest(".time-section") || sec;

            if (tabBtn && !tabBtn.classList.contains("active")) {
              const tab = new bootstrap.Tab(tabBtn);
              const onShown = () => {
                tabBtn.removeEventListener("shown.bs.tab", onShown);
                targetSection.scrollIntoView({ behavior: "smooth", block: "start" });
              };
              tabBtn.addEventListener("shown.bs.tab", onShown, { once: true });
              tab.show();
            } else {
              targetSection.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          });
          bar.appendChild(a);
        });
      }

      // 監聽分類切換，重繪書籤列
      function attachTabShownHandler() {
        const tabs = document.getElementById("categoryTabs");
        tabs.addEventListener("shown.bs.tab", (ev) => {
          const btn = ev.target;
          const idx = btn?.dataset?.catIdx ?? "0";
          renderTimeBookmarksForCategory(idx);
        });
      }

      // 轉義
      function escapeHTML(str) {
        return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;");
      }

      /** ============== 啟動流程 ============== */
      document.addEventListener("DOMContentLoaded", () => {
        // 1) 渲染 App
        renderApp(DATA);

        // 2) 自動高度 + 文字複製
        document.querySelectorAll(".auto-resize").forEach((t) => {
          autoResize(t);
          t.addEventListener("input", () => autoResize(t));
        });
        document.querySelectorAll(".copy-btn").forEach((btn) => {
          btn.addEventListener("click", () => copyFromSelector(btn.dataset.target, btn));
        });

        // 3) 先補「下載圖片」按鈕到每個 .img-actions，再綁定事件
        createDownloadButtons();
        wireImageInputs();

        // 4) 啟用分類切換監聽，並先渲染初始書籤
        attachTabShownHandler();
        renderTimeBookmarksForCategory(0);
      });
    </script>
  </body>
</html>
